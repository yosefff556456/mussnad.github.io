<!DOCTYPE html>
<html>
<head>
    <title>حساب السنتروايد وعرض الخريطة</title>
    <style>
        #map { height: 600px; width: 100%; }
        body { font-family: Arial, sans-serif; margin: 20px; }
        input[type="text"] { width: 80%; padding: 8px; margin: 5px 0; }
        button { padding: 10px 20px; }
    </style>
</head>
<body>
    <h2>تحميل ملفات CSV من روابط</h2>
    <label for="url1">رابط الملف الأول (Ancestors وAges):</label><br>
    <input type="text" id="url1" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRSIfLpWfT7orzKqBamCq7XHi9NH-uzU5aqILm0BF-OSPv8znF86aaMve8hJXfAJw/pub?output=csv" /><br><br>
    
    <label for="url2">رابط الملف الثاني (Ancestors وLatitude وLongitude):</label><br>
    <input type="text" id="url2" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vTg0hH5hBGLo4d83zuODbFLdF0RKFz-xKn2wFxnfWWMJPirCAf7aNgMOO35P3IwAw/pub?output=csv" /><br><br>
    
    <button onclick="processFiles()">حساب وعرض السنتروايد</button>
    
    <h2>الخريطة</h2>
    <div id="map"></div>

    <!-- تضمين المكتبات هنا -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-sA+e2N5pLkG4bAn+jAuPzkJlUqkf0s3bYV8mBM3B6AU="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-o9N1j6L0j2h3ReMKrIgX5hK4FJFd2VQ+J3ZbBTYI4Us="
     crossorigin=""></script>

    <script>
        // دالة لجلب ملف CSV من رابط ومعالجته
        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`خطأ في جلب الملف من الرابط: ${url}`);
            }
            const text = await response.text();
            const data = XLSX.read(text, { type: 'string' });
            const firstSheetName = data.SheetNames[0];
            const worksheet = data.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            return json;
        }

        // دالة لمعالجة البيانات واستخراج السلف النهائي
        function processData(data1, data2) {
            // تحويل بيانات الملف الثاني إلى خريطة للوصول السريع
            const ancestorCoordMap = {};
            // افترض أن الأعمدة هي: Ancestors, Latitude, Longitude
            for (let i = 1; i < data2.length; i++) {
                const row = data2[i];
                const ancestor = row[0];
                const latitude = parseFloat(row[1]);
                const longitude = parseFloat(row[2]);
                if (ancestor && !isNaN(latitude) && !isNaN(longitude)) {
                    ancestorCoordMap[ancestor] = { latitude, longitude };
                }
            }

            const terminalClades = [];

            // افترض أن الأعمدة في الملف الأول هي: Ancestors, Ages
            for (let i = 1; i < data1.length; i++) {
                const row = data1[i];
                const ancestors = row[0];
                const ages = row[1];
                if (!ancestors || !ages) continue;

                // استخراج السلف النهائي
                const ancestorParts = ancestors.split('>');
                let terminalAncestor = ancestorParts[ancestorParts.length - 1].trim();
                // إزالة العلامة '*' إن وجدت
                terminalAncestor = terminalAncestor.replace('*', '').trim();

                // استخراج العمر النهائي
                const ageParts = ages.split('>');
                const terminalAgeStr = ageParts[ageParts.length - 1].trim();
                const terminalAge = parseFloat(terminalAgeStr);

                if (!isNaN(terminalAge)) {
                    // جلب الإحداثيات من الملف الثاني
                    const coords = ancestorCoordMap[terminalAncestor];
                    if (coords) {
                        terminalClades.push({
                            ancestor: terminalAncestor,
                            latitude: coords.latitude,
                            longitude: coords.longitude,
                            weight: terminalAge // الوزن من الأعمار
                        });
                    }
                }
            }

            // الآن، معالجة الملف الثاني لإضافة الأوزان المزدوجة
            for (let i = 1; i < data2.length; i++) {
                const row = data2[i];
                const ancestor = row[0];
                const latitude = parseFloat(row[1]);
                const longitude = parseFloat(row[2]);
                if (ancestor && ancestorCoordMap[ancestor] && !terminalClades.find(c => c.ancestor === ancestor)) {
                    // إضافة السلف النهائي من الملف الثاني بوزن مزدوج
                    terminalClades.push({
                        ancestor: ancestor,
                        latitude: latitude,
                        longitude: longitude,
                        weight: 2 // ضعف الوزن
                    });
                }
            }

            return terminalClades;
        }

        // دالة لحساب السنتروايد الوزني
        function computeWeightedCentroid(data) {
            let sumLat = 0;
            let sumLon = 0;
            let totalWeight = 0;

            data.forEach(point => {
                sumLat += point.latitude * point.weight;
                sumLon += point.longitude * point.weight;
                totalWeight += point.weight;
            });

            return {
                latitude: sumLat / totalWeight,
                longitude: sumLon / totalWeight
            };
        }

        // دالة لعرض النقاط والسنتروايد على خريطة Leaflet
        function displayMap(data, centroid) {
            // تهيئة الخريطة
            const map = L.map('map').setView([centroid.latitude, centroid.longitude], 5);

            // إضافة طبقة الخرائط الأساسية
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // إضافة النقاط
            data.forEach(point => {
                L.circleMarker([point.latitude, point.longitude], {
                    radius: 5,
                    fillColor: '#3388ff',
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`سلف: ${point.ancestor}<br>وزن: ${point.weight}`).addTo(map);
            });

            // إضافة السنتروايد
            L.marker([centroid.latitude, centroid.longitude], {
                icon: L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    shadowSize: [41, 41]
                })
            }).addTo(map).bindPopup(`سنتروايد: (${centroid.latitude.toFixed(5)}, ${centroid.longitude.toFixed(5)})`).openPopup();
        }

        // دالة لمعالجة الملفات من إدخال المستخدم (URLs)
        async function processFiles() {
            const url1 = document.getElementById('url1').value.trim();
            const url2 = document.getElementById('url2').value.trim();

            if (!url1 || !url2) {
                alert('يرجى إدخال روابط كلا الملفين.');
                return;
            }

            try {
                const data1 = await fetchCSV(url1);
                const data2 = await fetchCSV(url2);
                const processedData = processData(data1, data2);
                if (processedData.length === 0) {
                    alert('لم يتم العثور على بيانات بعد المعالجة.');
                    return;
                }
                const centroid = computeWeightedCentroid(processedData);
                displayMap(processedData, centroid);
            } catch (error) {
                console.error('خطأ في تحميل أو معالجة الملفات:', error);
                alert('حدث خطأ أثناء تحميل أو معالجة الملفات. تحقق من الروابط وحاول مرة أخرى.');
            }
        }
    </script>
</body>
</html>
