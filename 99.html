import requests
from bs4 import BeautifulSoup
import json
import pandas as pd

# الرابط المطلوب
url = 'https://www.yfull.com/tree/J1/'

# تحميل محتوى الصفحة
response = requests.get(url)
if response.status_code == 200:
    html_content = response.text
else:
    print("خطأ في تحميل الصفحة. رمز الحالة:", response.status_code)
    exit()

# مسار ملف JSON الذي يحتوي على أكواد المناطق وإحداثياتها
json_file_path = 'region_coordinates.json'

# قراءة ملف JSON
with open(json_file_path, 'r', encoding='utf-8') as json_file:
    region_coordinates = json.load(json_file)

soup = BeautifulSoup(html_content, 'html.parser')

def get_lineage_and_tmrca(li_tag):
    lineage = []
    tmrca_values = []
    while li_tag and li_tag.name != 'div':
        if li_tag.name == 'li':
            a_tag = li_tag.find('a')
            tmrca_span = li_tag.find('span', text=lambda x: x and 'TMRCA' in x and 'ybp' in x)
            if a_tag:
                ancestor = a_tag.text.strip()
                lineage.append(ancestor)
                if tmrca_span:
                    # استخراج الرقم بين "TMRCA" و "ybp"
                    tmrca_text = tmrca_span.text.strip()
                    start = tmrca_text.find('TMRCA') + len('TMRCA')
                    end = tmrca_text.find('ybp')
                    tmrca_value = tmrca_text[start:end].strip() if start != -1 and end != -1 else None
                    tmrca_values.append(tmrca_value)
                else:
                    tmrca_values.append(None)
        li_tag = li_tag.parent
    return lineage[::-1], tmrca_values[::-1]  # نعكس القائمة للحصول على الترتيب من الجذر إلى الفرع

# البحث عن جميع العناصر التي تمثل الأشخاص
person_items = soup.find_all('li', attrs={'valsampleid': True})

# قائمة لتخزين البيانات
data_list = []

for person in person_items:
    # استخراج كود المنطقة
    b_tag = person.find('b', text=lambda x: x and '[' in x and ']' in x)
    if b_tag:
        region_code_full = b_tag.text.strip()
        # استخراج النص بين القوسين المربعين
        start = region_code_full.find('[') + 1
        end = region_code_full.find(']')
        region_code = region_code_full[start:end]

        # الحصول على الإحداثيات من ملف JSON
        coordinates = region_coordinates.get(region_code)
        if coordinates:
            if isinstance(coordinates, str):
                lat_long = coordinates.split(',')
                if len(lat_long) == 2:
                    latitude = lat_long[0].strip()
                    longitude = lat_long[1].strip()
                else:
                    latitude = None
                    longitude = None
            else:
                latitude = coordinates.get('latitude')
                longitude = coordinates.get('longitude')
        else:
            latitude = None
            longitude = None

        # بناء سلسلة الأسلاف وقيم TMRCA
        lineage, tmrca_values = get_lineage_and_tmrca(person)
        lineage_str = '>'.join(lineage)
        tmrca_str = '>'.join([tmrca if tmrca else '' for tmrca in tmrca_values])  # تحويل TMRCA إلى سلسلة

        # إضافة البيانات إلى القائمة
        data_list.append({
            'Ancestors': lineage_str,
            'TMRCA': tmrca_str,
            'Latitude': latitude,
            'Longitude': longitude
        })

# تحويل البيانات إلى DataFrame باستخدام pandas
df = pd.DataFrame(data_list)

# حفظ البيانات في ملف Excel
excel_file_path = 'output_data_with_tmrca.xlsx'
df.to_excel(excel_file_path, index=False)

print("تم حفظ البيانات في الملف:", excel_file_path)
