<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>حساب وعرض السنترويدات على خريطة</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- تضمين مكتبة Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-sA+e2YC+NmuZMBpRw6yjYkAxylKVY63fTnAbH6LC5M0="
          crossorigin=""/>
    
    <!-- تضمين مكتبة Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-o9N1j4ZT+TeSrtMz4MYb0kIG4m4kCPDUnN1Mjnk0c6E="
            crossorigin=""></script>
    
    <!-- تضمين مكتبة PapaParse لتحليل ملفات CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" integrity="sha512-yEM0RrD3UIwTCx0mB9VGZVPRhLeogUFqLPc8AMePQwkQjHoSCAOD3mdWqgXx9EUBt2mFE4emAyKpbxOAwNk2yg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <style>
        /* تنسيق الخريطة لتملأ الشاشة بالكامل */
        #map {
            height: 100vh;
            width: 100%;
        }
        /* تنسيق النافذة المنبثقة */
        .popup-content {
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script>
// رابط ملف CSV
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSIfLpWfT7orzKqBamCq7XHi9NH-uzU5aqILm0BF-OSPv8znF86aaMve8hJXfAJw/pub?output=csv";

// دالة لحساب السنترويدات الموزونة لكل سلف
function calculateCentroids(data) {
    const centroids = {};

    data.forEach((row, rowIndex) => {
        const ancestors = row.Ancestors.split('>').map(a => a.trim()).filter(a => a !== "");
        const tmrcas = row.TMRCA.split('>').map(t => parseInt(t.trim())).filter(t => !isNaN(t));
        const latitude = parseFloat(row.Latitude);
        const longitude = parseFloat(row.Longitude);

        // التحقق من صحة الإحداثيات
        if (isNaN(latitude) || isNaN(longitude)) {
            console.warn(`تم تخطي الصف رقم ${rowIndex + 2} بسبب إحداثيات غير صحيحة: Latitude = ${row.Latitude}, Longitude = ${row.Longitude}`);
            return;
        }

        ancestors.forEach((ancestor, index) => {
            const tmrca = tmrcas[index];
            if (!tmrca) {
                // إذا لم يكن هناك TMRCA لهذا المستوى، نتخطاه
                return;
            }

            if (!centroids[ancestor]) {
                centroids[ancestor] = {
                    lat_sum: 0,
                    lon_sum: 0,
                    weight_sum: 0
                };
            }

            centroids[ancestor].lat_sum += latitude * tmrca;
            centroids[ancestor].lon_sum += longitude * tmrca;
            centroids[ancestor].weight_sum += tmrca;
        });
    });

    // حساب المتوسط الموزون لكل سلف
    const centroidData = [];
    for (const ancestor in centroids) {
        const data = centroids[ancestor];
        const centroid_lat = data.weight_sum !== 0 ? data.lat_sum / data.weight_sum : 0;
        const centroid_lon = data.weight_sum !== 0 ? data.lon_sum / data.weight_sum : 0;
        centroidData.push({
            Ancestor: ancestor,
            Centroid_Latitude: centroid_lat,
            Centroid_Longitude: centroid_lon,
            TMRCA_Total: data.weight_sum
        });
    }

    console.log("السنترويدات المحسوبة:", centroidData);
    return centroidData;
}

// دالة لتهيئة الخريطة وعرض السنترويدات
function initializeMap(centroids) {
    if (centroids.length === 0) {
        alert("لم يتم حساب أي سنترويدات. تأكد من صحة البيانات.");
        return;
    }

    // تحديد النقطة الأولى كمركز مبدئي للخريطة
    const initialCenter = [centroids[0].Centroid_Latitude, centroids[0].Centroid_Longitude];

    // إنشاء خريطة Leaflet وتعيين مركزها ومقياسها الابتدائي
    const map = L.map('map').setView(initialCenter, 4); // يمكنك تغيير المقياس حسب الحاجة

    // إضافة طبقة خريطة OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // إنشاء طبقة للمجموعات (Layer Group)
    const centroidLayer = L.layerGroup().addTo(map);

    // ألوان مخصصة للسنترويدات (يمكنك تعديلها أو توليدها ديناميكيًا)
    const colors = ['#E55451', 'cyan', 'green', 'purple', 'pink', 'orange', 'yellow', 'blue', 'brown', 'grey'];

    centroids.forEach((centroid, index) => {
        const color = colors[index % colors.length]; // اختيار لون بناءً على الفهرس

        // إنشاء علامة (Marker) باستخدام دائرة ملونة
        const marker = L.circleMarker([centroid.Centroid_Latitude, centroid.Centroid_Longitude], {
            radius: 8,
            fillColor: color,
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(centroidLayer);

        // إضافة نافذة منبثقة (Popup) بمعلومات السنترويد
        marker.bindPopup(`
            <div class="popup-content">
                <strong>السلف:</strong> ${centroid.Ancestor}<br>
                <strong>إحداثيات السنترويد:</strong> (${centroid.Centroid_Latitude.toFixed(4)}, ${centroid.Centroid_Longitude.toFixed(4)})<br>
                <strong>TMRCA الإجمالي:</strong> ${centroid.TMRCA_Total} سنة
            </div>
        `);
    });

    // ضبط مستوى التكبير لتناسب جميع العلامات
    const group = new L.featureGroup(centroidLayer.getLayers());
    map.fitBounds(group.getBounds().pad(0.5));
}

// تحميل ومعالجة ملف CSV
Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        if (results.errors.length) {
            console.error("أخطاء في تحليل ملف CSV:", results.errors);
            alert("حدثت مشكلة في تحميل أو تحليل ملف البيانات.");
            return;
        }

        const data = results.data.map(row => ({
            Ancestors: row.Ancestors,
            TMRCA: row.TMRCA,
            Latitude: row.Latitude,
            Longitude: row.Longitude
        }));

        console.log("البيانات المحملة:", data);

        const centroids = calculateCentroids(data);
        initializeMap(centroids);
    },
    error: function(error) {
        console.error('خطأ في تحميل أو تحليل ملف CSV:', error);
        alert("حدث خطأ أثناء تحميل ملف البيانات.");
    }
});
</script>

</body>
</html>
