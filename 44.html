<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>عرض سلف J-Y5320 وأسلافه على خريطة</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 800px;
            width: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            direction: rtl; /* لجعل النصوص تتناسب مع اللغة العربية */
        }
        h2 {
            text-align: center;
        }
    </style>
</head>
<body>
    <h2>عرض سلف J-Y5320 وأسلافه على خريطة</h2>
    <div id="map"></div>

    <!-- مكتبة Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- مكتبة PapaParse لقراءة ملفات CSV -->
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script>
        // تهيئة الخريطة
        var map = L.map('map').setView([30, 30], 2); // ضبط الإحداثيات الافتراضية

        // إضافة طبقة الخريطة (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // رابط ملف CSV الذي قدمته
        var csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSd3p_h-602tPkzCmZFeWiSXqXHGN9glvTurS99FJGHv0vYZxkhG6n-gFlEIIurugm9FrlFQFOtgIy2/pub?output=csv';

        // السلف المطلوب عرضه
        var targetAncestor = 'J-Y5320';

        // تحميل ملف CSV
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            complete: function(results) {
                var data = results.data;
                var tree = {};
                var nodes = {};
                var relevantPaths = new Set();

                // أولاً، العثور على جميع المسارات التي تحتوي على السلف المستهدف
                data.forEach(function(row) {
                    var ancestors = row.Ancestors.split('>');
                    if (ancestors.includes(targetAncestor)) {
                        // إضافة جميع الأجزاء من بداية السلسلة حتى السلف المستهدف
                        var index = ancestors.indexOf(targetAncestor);
                        var path = ancestors.slice(0, index + 1).join('>');
                        relevantPaths.add(path);
                    }
                });

                // بناء الهيكل الشجري وتخزين الإحداثيات فقط للمسارات ذات الصلة
                data.forEach(function(row) {
                    var ancestors = row.Ancestors.split('>');
                    // تحقق مما إذا كانت هذه السلسلة جزءًا من المسارات ذات الصلة
                    for (var i = 1; i <= ancestors.length; i++) {
                        var subPath = ancestors.slice(0, i).join('>');
                        if (relevantPaths.has(subPath)) {
                            // إذا كانت هذه السلسلة تتضمن السلف المستهدف
                            if (i === ancestors.length && row.Latitude && row.Longitude) {
                                nodes[subPath] = {
                                    name: ancestors[i - 1],
                                    lat: parseFloat(row.Latitude),
                                    lng: parseFloat(row.Longitude)
                                };
                            }
                        }
                    }
                });

                // تقدير المواقع للأجداد بدون إحداثيات بناءً على متوسط إحداثيات الأبناء
                data.forEach(function(row) {
                    var ancestors = row.Ancestors.split('>');
                    for (var i = 0; i < ancestors.length -1; i++) {
                        var ancestorPath = ancestors.slice(0, i+1).join('>');
                        if (ancestorPath !== targetAncestor && relevantPaths.has(ancestorPath) && !nodes[ancestorPath]) {
                            // ابحث عن جميع الأبناء المباشرين
                            var children = data.filter(function(childRow) {
                                return childRow.Ancestors.startsWith(ancestorPath + '>');
                            });
                            var sumLat = 0, sumLng = 0, count = 0;
                            children.forEach(function(child) {
                                if (child.Latitude && child.Longitude) {
                                    sumLat += parseFloat(child.Latitude);
                                    sumLng += parseFloat(child.Longitude);
                                    count++;
                                }
                            });
                            if (count > 0) {
                                nodes[ancestorPath] = {
                                    name: ancestors[i],
                                    lat: sumLat / count,
                                    lng: sumLng / count
                                };
                            }
                        }
                    }
                });

                // إضافة العلامات والخطوط إلى الخريطة
                for (var path in nodes) {
                    var node = nodes[path];
                    // إضافة علامة مع نص
                    var marker = L.marker([node.lat, node.lng]).addTo(map)
                        .bindPopup(node.name)
                        .bindTooltip(node.name, {permanent: true, direction: 'right'});

                    // رسم الخطوط بناءً على العلاقة الشجرية
                    var ancestors = path.split('>');
                    if (ancestors.length > 1) {
                        var parentPath = ancestors.slice(0, -1).join('>');
                        if (nodes[parentPath]) {
                            var parent = nodes[parentPath];
                            L.polyline([[parent.lat, parent.lng], [node.lat, node.lng]], {color: 'blue'}).addTo(map);
                        }
                    }
                }

                // ضبط عرض الخريطة بحيث يتناسب مع العلامات المضافة
                var group = new L.featureGroup(Object.values(nodes).map(function(node) {
                    return L.marker([node.lat, node.lng]);
                }));
                map.fitBounds(group.getBounds().pad(0.5));
            },
            error: function(error) {
                console.error("حدث خطأ أثناء تحميل ملف CSV:", error);
            }
        });
    </script>
</body>
</html>
