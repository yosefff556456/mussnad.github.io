<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>عرض الأنساب على خريطة</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 800px;
            width: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            direction: rtl; /* لجعل النصوص تتناسب مع اللغة العربية */
        }
        h2 {
            text-align: center;
        }
    </style>
</head>
<body>
    <h2>عرض الأنساب على خريطة</h2>
    <div id="map"></div>

    <!-- مكتبة Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- مكتبة PapaParse لقراءة ملفات CSV -->
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script>
        // تهيئة الخريطة
        var map = L.map('map').setView([30, 30], 2); // ضبط الإحداثيات الافتراضية

        // إضافة طبقة الخريطة (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // رابط ملف CSV الذي قدمته
        var csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSd3p_h-602tPkzCmZFeWiSXqXHGN9glvTurS99FJGHv0vYZxkhG6n-gFlEIIurugm9FrlFQFOtgIy2/pub?output=csv';

        // تحميل ملف CSV
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            complete: function(results) {
                var data = results.data;
                var tree = {};
                var nodes = {};

                // بناء الهيكل الشجري وتخزين الإحداثيات
                data.forEach(function(row) {
                    var ancestors = row.Ancestors.split('>');
                    var currentPath = '';
                    ancestors.forEach(function(name, index) {
                        currentPath = index === 0 ? name : currentPath + '>' + name;
                        if (!tree[currentPath]) {
                            tree[currentPath] = {
                                name: name,
                                children: {},
                                path: currentPath
                            };
                        }
                        if (index === ancestors.length -1 && row.Latitude && row.Longitude) {
                            nodes[currentPath] = {
                                name: name,
                                lat: parseFloat(row.Latitude),
                                lng: parseFloat(row.Longitude)
                            };
                        }
                    });
                });

                // تقدير المواقع للأجداد بدون إحداثيات بناءً على متوسط إحداثيات الأبناء
                data.forEach(function(row) {
                    var ancestors = row.Ancestors.split('>');
                    for (var i = 0; i < ancestors.length -1; i++) {
                        var ancestorPath = ancestors.slice(0, i+1).join('>');
                        if (!nodes[ancestorPath]) {
                            // ابحث عن جميع الأبناء المباشرين
                            var children = data.filter(function(childRow) {
                                return childRow.Ancestors.startsWith(ancestorPath + '>');
                            });
                            var sumLat = 0, sumLng = 0, count = 0;
                            children.forEach(function(child) {
                                if (child.Latitude && child.Longitude) {
                                    sumLat += parseFloat(child.Latitude);
                                    sumLng += parseFloat(child.Longitude);
                                    count++;
                                }
                            });
                            if (count > 0) {
                                nodes[ancestorPath] = {
                                    name: ancestors[i],
                                    lat: sumLat / count,
                                    lng: sumLng / count
                                };
                            }
                        }
                    }
                });

                // إضافة العلامات والخطوط إلى الخريطة
                for (var path in nodes) {
                    var node = nodes[path];
                    // إضافة علامة مع نص
                    var marker = L.marker([node.lat, node.lng]).addTo(map)
                        .bindPopup(node.name)
                        .bindTooltip(node.name, {permanent: true, direction: 'right'});

                    // رسم الخطوط بناءً على العلاقة الشجري
                    var ancestors = path.split('>');
                    if (ancestors.length > 1) {
                        var parentPath = ancestors.slice(0, -1).join('>');
                        if (nodes[parentPath]) {
                            var parent = nodes[parentPath];
                            L.polyline([[parent.lat, parent.lng], [node.lat, node.lng]], {color: 'blue'}).addTo(map);
                        }
                    }
                }
            },
            error: function(error) {
                console.error("حدث خطأ أثناء تحميل ملف CSV:", error);
            }
        });
    </script>
</body>
</html>

