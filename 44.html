<!DOCTYPE html>
<html>
<head>
    <title>خريطة الأسلاف التفاعلية</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- تحميل مكتبة Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <!-- تحميل مكتبة PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .ancestor-label {
            font-weight: bold;
            text-align: center;
            color: black;
            text-shadow: 1px 1px 2px white;
        }
        .highlighted-ancestor-label {
            font-weight: bold;
            text-align: center;
            color: red; /* لون النص المختلف */
            text-shadow: 1px 1px 2px white;
            border: 2px solid red; /* إطار ملون */
            border-radius: 5px;
            padding: 2px;
        }
    </style>
</head>
<body>

<h2>خريطة الأسلاف التفاعلية</h2>
<div id="map"></div>

<!-- تحميل مكتبة Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<!-- كود JavaScript -->
<script>
// رابط ملف CSV
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpMbhaSndsY1yipwmmM1nBlu3lbTrx1XUTrant5BrPmE_LoZQdKQPUwowoFf39Xw/pub?output=csv';

// إنشاء الخريطة
const map = L.map('map').setView([16.6161, 43.0556], 6);

// إضافة طبقة الخريطة
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; مساهمة OpenStreetMap'
}).addTo(map);

// دالة لحساب المتوسط الموزون للإحداثيات
function calculateWeightedCoordinates(samples) {
    let totalLat = 0;
    let totalLon = 0;
    let totalWeight = 0;
    samples.forEach(sample => {
        const weight = sample.weight;
        totalLat += parseFloat(sample.lat) * weight;
        totalLon += parseFloat(sample.lon) * weight;
        totalWeight += weight;
    });
    return {
        lat: totalLat / totalWeight,
        lon: totalLon / totalWeight
    };
}

// بناء هيكل الأسلاف
function buildAncestorsTree(data) {
    const ancestorsTree = {};

    data.forEach(item => {
        const ancestorsStr = item['Ancestors'];
        let lat = item['Latitude'].replace(',', '.').replace('٫', '.');
        let lon = item['Longitude'].replace(',', '.').replace('٫', '.');

        if (ancestorsStr && lat && lon) {
            const ancestorList = ancestorsStr.split('>');
            // إزالة أي عناصر فارغة
            const filteredAncestorList = ancestorList.filter(ancestor => ancestor.trim() !== '');

            filteredAncestorList.forEach((ancestor, index) => {
                const ancestorKey = filteredAncestorList.slice(0, index + 1).join('>');
                if (!ancestorsTree[ancestorKey]) {
                    ancestorsTree[ancestorKey] = {
                        name: ancestor,
                        parent: index > 0 ? filteredAncestorList.slice(0, index).join('>') : null,
                        samples: [],
                        children: [],
                        level: index // مستوى السلف في الشجرة
                    };
                }
                // إذا كان هذا هو السلف الأخير في القائمة، أضف العينة إليه
                if (index === filteredAncestorList.length - 1) {
                    ancestorsTree[ancestorKey].samples.push({ lat: lat, lon: lon, weight: 1 });
                }
            });
        }
    });

    // بناء العلاقات بين الأسلاف
    Object.values(ancestorsTree).forEach(node => {
        if (node.parent && ancestorsTree[node.parent]) {
            ancestorsTree[node.parent].children.push(node);
        }
    });

    return ancestorsTree;
}

// دالة لإيجاد مسار إلى سلف معين
function findPathToAncestor(ancestorsTree, targetName) {
    for (const key in ancestorsTree) {
        if (ancestorsTree[key].name === targetName) {
            const path = [];
            let current = ancestorsTree[key];
            while (current) {
                path.unshift(current);
                current = current.parent ? ancestorsTree[current.parent] : null;
            }
            return path;
        }
    }
    return [];
}

// دالة لإضافة الأسلاف إلى الخريطة وتحريك العلامة
function addAncestorsToMap(pathToTarget) {
    if (pathToTarget.length === 0) {
        console.error('لا يوجد مسار إلى السلف المستهدف.');
        return;
    }

    const migrationPathCoords = [];
    const ancestorCoords = [];

    // جمع إحداثيات المسار
    pathToTarget.forEach(node => {
        if (node.samples.length > 0) {
            const coords = calculateWeightedCoordinates(node.samples);
            migrationPathCoords.push([coords.lat, coords.lon]);
            ancestorCoords.push({
                name: node.name,
                lat: coords.lat,
                lon: coords.lon,
                isTarget: node.name === 'J-Y5320'
            });
        }
    });

    // رسم مسار الهجرة
    const migrationPath = L.polyline(migrationPathCoords, { color: 'blue', weight: 3 }).addTo(map);
    map.fitBounds(migrationPath.getBounds());

    // إعداد العلامة المتحركة
    let currentIndex = 0;

    // إنشاء العلامة المتحركة
    const movingMarker = L.marker(migrationPathCoords[0], { 
        icon: L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            shadowSize: [41, 41]
        })
    }).addTo(map);

    // دالة لتحريك العلامة وإضافة العلامات عند كل سلف
    function moveMarker() {
        currentIndex++;
        if (currentIndex >= migrationPathCoords.length) {
            clearInterval(interval);
            return;
        }

        // تحريك العلامة إلى الموقع التالي
        movingMarker.setLatLng(migrationPathCoords[currentIndex]);

        // إضافة علامة السلف عند هذا الموقع
        const ancestor = ancestorCoords[currentIndex];
        const isTarget = ancestor.isTarget;

        // إنشاء أيقونة نصية لعرض اسم السلف
        const myIcon = L.divIcon({
            className: isTarget ? 'highlighted-ancestor-label' : 'ancestor-label',
            html: `<div style="font-size: ${16 + (5 * (5 - pathToTarget[currentIndex].level)}px;">${ancestor.name}</div>`
        });

        // إضافة العلامة إلى الخريطة
        L.marker([ancestor.lat, ancestor.lon], { icon: myIcon }).addTo(map);

        // يمكن إضافة Popup لعرض معلومات إضافية إذا رغبت
        /*
        L.marker([ancestor.lat, ancestor.lon], { icon: myIcon })
            .addTo(map)
            .bindPopup(`<b>${ancestor.name}</b><br>معلومات إضافية هنا.`);
        */
    }

    // تحريك العلامة كل ثانية (1000 مللي ثانية)
    const interval = setInterval(moveMarker, 1000);
}

// تحميل ومعالجة ملف CSV
fetch(csvUrl)
    .then(response => response.text())
    .then(csvText => {
        Papa.parse(csvText, {
            header: true,
            delimiter: ',',
            complete: function(results) {
                const data = results.data;
                // بناء هيكل الأسلاف
                const ancestorsTree = buildAncestorsTree(data);

                // إيجاد المسار إلى "J-Y5320"
                const pathToJY5320 = findPathToAncestor(ancestorsTree, 'J-Y5320');

                if (pathToJY5320.length === 0) {
                    console.error('لم يتم العثور على السلف "J-Y5320" في البيانات.');
                    return;
                }

                // إضافة الأسلاف إلى الخريطة وتحريك العلامة
                addAncestorsToMap(pathToJY5320);
            }
        });
    })
    .catch(error => {
        console.error('خطأ في تحميل ملف CSV:', error);
    });
</script>
</body>
</html>

