<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>عرض سلف J-Y5320 وأسلافه على خريطة</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 800px;
            width: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            direction: rtl; /* لجعل النصوص تتناسب مع اللغة العربية */
        }
        h2 {
            text-align: center;
        }
        .label-text {
            background-color: white;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #ccc;
            font-size: 12px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <h2>عرض سلف J-Y5320 وأسلافه على خريطة</h2>
    <div id="map"></div>

    <!-- مكتبة Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- مكتبة PapaParse لقراءة ملفات CSV -->
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script>
        // تهيئة الخريطة
        var map = L.map('map').setView([30, 30], 2); // ضبط الإحداثيات الافتراضية

        // إضافة طبقة الخريطة (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // رابط ملف CSV الذي قدمته
        var csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSd3p_h-602tPkzCmZFeWiSXqXHGN9glvTurS99FJGHv0vYZxkhG6n-gFlEIIurugm9FrlFQFOtgIy2/pub?output=csv';

        // السلف المطلوب عرضه
        var targetAncestor = 'J-Y5320';

        // تحميل ملف CSV
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            complete: function(results) {
                var data = results.data;
                var nodes = {}; // لتخزين معلومات الأنساب
                var tree = {}; // هيكل الشجرة
                var connections = []; // لتخزين العلاقات بين الأنساب

                // بناء هيكل الشجرة وتخزين الإحداثيات إذا كانت موجودة
                data.forEach(function(row) {
                    var ancestors = row.Ancestors.split('>');
                    var currentPath = '';
                    ancestors.forEach(function(name, index) {
                        currentPath = index === 0 ? name : currentPath + '>' + name;
                        if (!tree[currentPath]) {
                            tree[currentPath] = {
                                name: name,
                                children: [],
                                parent: index > 0 ? ancestors.slice(0, index).join('>') : null,
                                lat: row.Latitude && row.Longitude ? parseFloat(row.Latitude) : null,
                                lng: row.Latitude && row.Longitude ? parseFloat(row.Longitude) : null
                            };
                        }
                        // ربط الأب بالأبناء
                        if (index > 0) {
                            var parentPath = ancestors.slice(0, index).join('>');
                            tree[parentPath].children.push(currentPath);
                        }
                    });
                });

                // تصفية الأنساب ذات الصلة بـ targetAncestor
                Object.keys(tree).forEach(function(path) {
                    if (path.includes(targetAncestor)) {
                        nodes[path] = tree[path];
                    }
                });

                // وظيفة لتقدير إحداثيات الأنساب بدون إحداثيات بناءً على متوسط إحداثيات الأبناء
                function estimateCoordinates(path) {
                    var node = tree[path];
                    if (node.lat !== null && node.lng !== null) {
                        return; // إذا كان هناك إحداثيات، لا حاجة للتقدير
                    }
                    if (node.children.length === 0) {
                        return; // لا يمكن تقدير بدون أبناء
                    }
                    var sumLat = 0, sumLng = 0, count = 0;
                    node.children.forEach(function(childPath) {
                        var child = tree[childPath];
                        if (child.lat !== null && child.lng !== null) {
                            sumLat += child.lat;
                            sumLng += child.lng;
                            count++;
                        }
                    });
                    if (count > 0) {
                        node.lat = sumLat / count;
                        node.lng = sumLng / count;
                        nodes[path].lat = node.lat;
                        nodes[path].lng = node.lng;
                    }
                }

                // تقدير إحداثيات جميع الأنساب بدون إحداثيات بترتيب تصاعدي من الأجداد إلى السلف المستهدف
                var paths = Object.keys(tree).filter(path => path.includes(targetAncestor));
                paths.sort(function(a, b) {
                    return a.split('>').length - b.split('>').length;
                });
                paths.forEach(function(path) {
                    if (nodes[path]) {
                        estimateCoordinates(path);
                    }
                });

                // جمع جميع الأنساب المتعلقة بـ targetAncestor
                var relevantNodes = {};
                Object.keys(tree).forEach(function(path) {
                    if (path.includes(targetAncestor)) {
                        relevantNodes[path] = tree[path];
                    }
                });

                // تقدير الإحداثيات للأجداد بدون إحداثيات بشكل متكرر حتى لا تبقى أي سلالات بدون إحداثيات إذا كان ذلك ممكنًا
                var updated;
                do {
                    updated = false;
                    Object.keys(relevantNodes).forEach(function(path) {
                        var node = relevantNodes[path];
                        if ((node.lat === null || node.lng === null) && node.children.length > 0) {
                            var sumLat = 0, sumLng = 0, count = 0;
                            node.children.forEach(function(childPath) {
                                var child = relevantNodes[childPath];
                                if (child.lat !== null && child.lng !== null) {
                                    sumLat += child.lat;
                                    sumLng += child.lng;
                                    count++;
                                }
                            });
                            if (count > 0) {
                                node.lat = sumLat / count;
                                node.lng = sumLng / count;
                                updated = true;
                            }
                        }
                    });
                } while (updated);

                // إضافة الأنساب مع إحداثياتها إلى الخريطة
                Object.keys(relevantNodes).forEach(function(path) {
                    var node = relevantNodes[path];
                    if (node.lat !== null && node.lng !== null) {
                        // إضافة نص كعلامة
                        L.marker([node.lat, node.lng], {
                            icon: L.divIcon({
                                className: 'label-text',
                                html: node.name,
                                iconSize: [100, 40],
                                iconAnchor: [50, 20],
                                direction: 'right'
                            })
                        }).addTo(map);

                        // ربط الأب بالابن
                        if (node.parent && relevantNodes[node.parent] && relevantNodes[node.parent].lat && relevantNodes[node.parent].lng) {
                            connections.push([node.parent, path]);
                        }
                    }
                });

                // رسم الخطوط بين الأنساب
                connections.forEach(function(connection) {
                    var parentPath = connection[0];
                    var childPath = connection[1];
                    var parent = relevantNodes[parentPath];
                    var child = relevantNodes[childPath];
                    if (parent && child && parent.lat && parent.lng && child.lat && child.lng) {
                        L.polyline([[parent.lat, parent.lng], [child.lat, child.lng]], {color: 'blue'}).addTo(map);
                    }
                });

                // ضبط عرض الخريطة بحيث يتناسب مع العلامات المضافة
                var markers = Object.keys(relevantNodes).map(function(path) {
                    var node = relevantNodes[path];
                    if (node.lat !== null && node.lng !== null) {
                        return L.marker([node.lat, node.lng]);
                    }
                }).filter(marker => marker !== undefined);
                if (markers.length > 0) {
                    var group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.5));
                }
            },
            error: function(error) {
                console.error("حدث خطأ أثناء تحميل ملف CSV:", error);
            }
        });
    </script>
</body>
</html>
