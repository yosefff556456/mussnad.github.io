<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>عرض سلف J-Y5320 وأسلافه على خريطة</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 800px;
            width: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            direction: rtl; /* لجعل النصوص تتناسب مع اللغة العربية */
        }
        h2 {
            text-align: center;
        }
        .label-text {
            background-color: white;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #ccc;
            font-size: 12px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <h2>عرض سلف J-Y5320 وأسلافه على خريطة</h2>
    <div id="map"></div>

    <!-- مكتبة Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- مكتبة PapaParse لقراءة ملفات CSV -->
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script>
        // تهيئة الخريطة
        var map = L.map('map').setView([30, 30], 2); // ضبط الإحداثيات الافتراضية

        // إضافة طبقة الخريطة (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // رابط ملف CSV الذي قدمته
        var csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSd3p_h-602tPkzCmZFeWiSXqXHGN9glvTurS99FJGHv0vYZxkhG6n-gFlEIIurugm9FrlFQFOtgIy2/pub?output=csv';

        // السلف المطلوب عرضه
        var targetAncestor = 'J-Y5320';

        // تحميل ملف CSV
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                var data = results.data;
                var nodes = {}; // لتخزين معلومات السلف
                var parentChildrenMap = {}; // لتخزين العلاقات بين الأب والأبناء

                // تصفية البيانات لتشمل فقط السلسلة التي تحتوي على targetAncestor
                var relevantData = data.filter(function(row) {
                    var ancestors = row.Ancestors.split('>');
                    return ancestors.includes(targetAncestor);
                });

                // بناء nodes وتحديد العلاقات بين الأب والأبناء
                relevantData.forEach(function(row) {
                    var ancestors = row.Ancestors.split('>');
                    for (var i = 0; i < ancestors.length; i++) {
                        var ancestorPath = ancestors.slice(0, i + 1).join('>');
                        var ancestorName = ancestors[i];

                        if (!nodes[ancestorPath]) {
                            nodes[ancestorPath] = {
                                name: ancestorName,
                                lat: row.Latitude ? parseFloat(row.Latitude) : null,
                                lng: row.Longitude ? parseFloat(row.Longitude) : null,
                                children: []
                            };
                        }

                        if (i < ancestors.length - 1) {
                            var childPath = ancestors.slice(0, i + 2).join('>');
                            nodes[ancestorPath].children.push(childPath);
                        }
                    }
                });

                // بناء خريطة العلاقات الأب-ابن
                for (var path in nodes) {
                    var node = nodes[path];
                    node.children.forEach(function(childPath) {
                        if (!parentChildrenMap[path]) {
                            parentChildrenMap[path] = [];
                        }
                        parentChildrenMap[path].push(childPath);
                    });
                }

                // دالة لتقدير الإحداثيات بناءً على أبناء السلف
                function estimateCoordinates(path) {
                    if (nodes[path].lat !== null && nodes[path].lng !== null) {
                        return; // إذا كانت الإحداثيات موجودة، لا حاجة للتقدير
                    }

                    var children = parentChildrenMap[path];
                    if (!children || children.length === 0) {
                        return; // لا يوجد أبناء لتقدير الإحداثيات
                    }

                    var sumLat = 0, sumLng = 0, count = 0;
                    children.forEach(function(childPath) {
                        if (nodes[childPath].lat !== null && nodes[childPath].lng !== null) {
                            sumLat += nodes[childPath].lat;
                            sumLng += nodes[childPath].lng;
                            count++;
                        }
                    });

                    if (count > 0) {
                        nodes[path].lat = sumLat / count;
                        nodes[path].lng = sumLng / count;
                    }
                }

                // عملية التقدير التكرارية للأجداد بدون إحداثيات
                var updated;
                do {
                    updated = false;
                    for (var path in nodes) {
                        if (nodes[path].lat === null || nodes[path].lng === null) {
                            var beforeLat = nodes[path].lat;
                            var beforeLng = nodes[path].lng;
                            estimateCoordinates(path);
                            if (nodes[path].lat !== beforeLat || nodes[path].lng !== beforeLng) {
                                updated = true;
                            }
                        }
                    }
                } while (updated);

                // الآن جميع الأنساب يجب أن تمتلك إحداثيات أو لا يمكن تقديرها
                // إنشاء مصفوفة للإحداثيات بالترتيب من الأجداد إلى السلف المستهدف
                var allPaths = Object.keys(nodes).filter(function(path) {
                    return path.split('>').includes(targetAncestor);
                });

                // بناء المسارات المرتبة
                var orderedPaths = allPaths.map(function(path) {
                    return path.split('>');
                });

                // اختيار المسار الذي ينتهي بـ targetAncestor
                // إذا كان هناك أكثر من مسار، سنقوم بدمجها بطريقة ما
                // لكن عادةً يكون هناك مسار واحد رئيسي

                // لإنشاء خط هجرة مستمر، سنحتاج إلى تحديد تسلسل زمني أو منطقي
                // إذا لم يكن هناك معلومات إضافية، سنفترض الترتيب من الجذر إلى الهدف

                // العثور على المسار الرئيسي (أول مسار يحتوي على الجذر J1)
                var mainPath = orderedPaths.find(function(pathArray) {
                    return pathArray[0] === 'J1';
                });

                if (!mainPath) {
                    console.error("لم يتم العثور على مسار يبدأ بـ 'J1'.");
                    return;
                }

                // إنشاء مصفوفة للإحداثيات بالترتيب من الأجداد إلى السلف المستهدف
                var latlngs = [];
                var markers = [];

                mainPath.forEach(function(name, index) {
                    var path = mainPath.slice(0, index + 1).join('>');
                    var node = nodes[path];
                    if (node.lat !== null && node.lng !== null) {
                        latlngs.push([node.lat, node.lng]);

                        // إنشاء علامة نصية
                        var label = L.marker([node.lat, node.lng], {
                            icon: L.divIcon({
                                className: 'label-text',
                                html: node.name,
                                iconSize: [100, 40],
                                iconAnchor: [50, 20],
                                direction: 'right'
                            })
                        }).addTo(map);
                        markers.push(label);
                    }
                });

                // رسم خط الهجرة المستمر
                var polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);

                // ضبط عرض الخريطة بحيث يتناسب مع العلامات المضافة
                var group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.5));
            },
            error: function(error) {
                console.error("حدث خطأ أثناء تحميل ملف CSV:", error);
            }
        });
    </script>
</body>
</html>

