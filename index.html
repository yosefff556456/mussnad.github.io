<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>جلب بيانات YFull وعرضها في جدول</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>جلب بيانات YFull وعرضها في جدول</h1>
    <input type="text" id="treeId" placeholder="أدخل معرف الشجرة (مثال: J-Y196305)" />
    <button id="fetchButton">جلب البيانات</button>

    <h2>البيانات المستخرجة:</h2>
    <div id="output">البيانات ستظهر هنا...</div>

    <script>
        document.getElementById('fetchButton').addEventListener('click', () => {
            const treeId = document.getElementById('treeId').value.trim();
            const output = document.getElementById('output');

            if (!treeId) {
                alert('يرجى إدخال معرف الشجرة.');
                return;
            }

            output.innerHTML = 'جاري جلب البيانات...';

            const proxyUrl = 'https://api.allorigins.win/get?url=';
            const targetUrl = encodeURIComponent(`https://www.yfull.com/tree/${treeId}/`);

            fetch(proxyUrl + targetUrl)
                .then(response => {
                    if (response.status !== 200) {
                        throw new Error('فشل في جلب البيانات من الوكيل.');
                    }
                    return response.json();
                })
                .then(data => {
                    const html = data.contents;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const ageSpans = doc.querySelectorAll('span.yf-age');
                    const extractedData = [];

                    // تخزين العلاقات الأصلية بين العقد
                    const parentMap = new Map();

                    // بناء خريطة الوالدين
                    const allLiElements = doc.querySelectorAll('li[id^="lJ-"], li[id^="lJ-Y"]');
                    allLiElements.forEach(li => {
                        const parentLi = li.closest('ul').parentElement.closest('li');
                        if (parentLi) {
                            parentMap.set(li, parentLi);
                        }
                    });

                    // تعريف الشرط: TMRCA < 15000 ybp
                    const condition = (tmrca) => {
                        return tmrca < 15000;
                    };

                    ageSpans.forEach(span => {
                        const ageText = span.textContent.trim();
                        // استخراج قيمة TMRCA
                        const tmrcaMatch = ageText.match(/TMRCA\s+(\d+)\s+ybp/i);
                        if (tmrcaMatch && tmrcaMatch[1]) {
                            const tmrcaValue = parseInt(tmrcaMatch[1], 10);
                            if (condition(tmrcaValue)) { // الشرط هنا
                                // استخراج بيانات AGE
                                const ageData = ageText;

                                // بناء سلسلة الأسلاف
                                let currentLi = span.closest('li');
                                const ancestorChain = [];
                                while (currentLi) {
                                    const aTag = currentLi.querySelector('a');
                                    if (aTag) {
                                        ancestorChain.unshift(aTag.textContent.trim());
                                    }
                                    currentLi = parentMap.get(currentLi);
                                }
                                const ancestorString = ancestorChain.join(' > ');

                                // إضافة البيانات المستخرجة إلى المصفوفة
                                extractedData.push({
                                    age: ageData,
                                    ancestors: ancestorString
                                });
                            }
                        }
                    });

                    if (extractedData.length === 0) {
                        output.textContent = 'لم يتم العثور على بيانات متاحة بناءً على الشرط المحدد.';
                        return;
                    }

                    // بناء الجدول
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    const th1 = document.createElement('th');
                    th1.textContent = 'الAGE';
                    const th2 = document.createElement('th');
                    th2.textContent = 'الأسلاف';
                    headerRow.appendChild(th1);
                    headerRow.appendChild(th2);
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');

                    extractedData.forEach(item => {
                        const row = document.createElement('tr');
                        const tdAge = document.createElement('td');
                        tdAge.textContent = item.age;
                        const tdAncestors = document.createElement('td');
                        tdAncestors.textContent = item.ancestors;
                        row.appendChild(tdAge);
                        row.appendChild(tdAncestors);
                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    output.innerHTML = '';
                    output.appendChild(table);
                })
                .catch(error => {
                    console.error(error);
                    output.textContent = `حدث خطأ أثناء جلب البيانات: ${error.message}`;
                });
        });
    </script>
</body>
</html>
